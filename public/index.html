<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Earth Lens - Capture Hazard</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <h1>Earth Lens</h1>
  <p>Capture potholes, waste dumps, or water/shoreline pollution.</p>
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <button id="capture">Capture Photo</button>
  <button id="submit" disabled>Submit</button>
  <p id="status">Requesting camera access...</p>
  <a href="dashboard.html">View Live Map Dashboard</a>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-functions.js";
    import { openDB } from "https://cdn.jsdelivr.net/npm/idb@8/build/iife/index-min.js";

    // Replace with your Firebase config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const functions = getFunctions(app);

    let db;
    openDB('earthlens-queue', 1, {
      upgrade(db) {
        db.createObjectStore('submissions', { autoIncrement: true });
      }
    }).then(opened => db = opened);

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('capture');
    const submitBtn = document.getElementById('submit');
    const status = document.getElementById('status');

    let imageData = null;
    let location = null;

    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
      .then(stream => {
        video.srcObject = stream;
        status.textContent = 'Camera ready. Tap Capture Photo.';
      })
      .catch(err => status.textContent = 'Camera error: ' + err.message);

    captureBtn.onclick = () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      imageData = canvas.toDataURL('image/jpeg', 0.85);
      status.textContent = 'Photo captured. Getting location...';
      captureBtn.disabled = true;
      submitBtn.disabled = true;

      navigator.geolocation.getCurrentPosition(pos => {
        location = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        status.textContent = 'Location acquired. Ready to submit.';
        submitBtn.disabled = false;
      }, err => {
        status.textContent = 'Location error: ' + err.message;
      });
    };

    submitBtn.onclick = async () => {
      if (!imageData || !location) return;
      status.textContent = 'Processing...';
      submitBtn.disabled = true;

      if (!auth.currentUser) await signInAnonymously(auth);

      const submission = {
        imageBase64: imageData.split(',')[1],
        lat: location.lat,
        lng: location.lng,
        timestamp: Date.now(),
        uid: auth.currentUser.uid
      };

      if (navigator.onLine) {
        await sendToServer(submission);
      } else {
        await db.put('submissions', submission);
        status.textContent = 'Offline: Submission queued.';
        registerSync();
      }

      captureBtn.disabled = false;
      submitBtn.disabled = true;
      imageData = null;
      location = null;
    };

    async function sendToServer(submission) {
      const verifyHazard = httpsCallable(functions, 'verifyHazard');
      try {
        const result = await verifyHazard(submission);
        if (result.data.success) {
          status.textContent = 'Verified and uploaded!';
        } else {
          status.textContent = 'Rejected: ' + result.data.reason;
        }
      } catch (err) {
        await db.put('submissions', submission);
        status.textContent = 'Error - queued for retry.';
        registerSync();
      }
    }

    async function registerSync() {
      if ('serviceWorker' in navigator && 'SyncManager' in window) {
        const reg = await navigator.serviceWorker.ready;
        await reg.sync.register('upload-queue');
      }
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }
  </script>
</body>
</html>
